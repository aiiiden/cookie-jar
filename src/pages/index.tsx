import { ConnectButton } from '@rainbow-me/rainbowkit';
import type { NextPage } from 'next';
import Head from 'next/head';
import styles from '../styles/Home.module.css';
import { useEffect, useState } from 'react';
import Modal from 'react-modal';
import { useAccount, useDeployContract, useWaitForTransactionReceipt, useChainId } from 'wagmi';
import { getBalance } from '@wagmi/core'
import { config } from '../wagmi';

export type Jar = {
  name: string;
  description: string;
  contractAddress: string;
  balance: number;
};

export const validChainIds = config.chains.map((chain) => chain.id);

export const pythAddress: { [key in typeof validChainIds[number]]: string } = {
  11155111: '0xDd24F84d36BF92C65F92307595335bdFab5Bbd21',   // Ethereum Sepolia
  11155420: '0x0708325268dF9F66270F1401206434524814508b',   // Optimism Sepolia
  84532: '0xA2aa501b19aff244D90cc15a4Cf739D2725B5729',      // Base Sepolia
  44787: '0x74f09cb3c7e2A01865f424FD14F6dc9A14E3e94E',      // Celo Alfajores
  8453: '0x8250f4aF4B972684F7b336503E2D6dFeDeB1487a',       // Base
  42220: '0xff1a0f4744e8582DF1aE09D5611b887B6a12925C',      // Celo
};

export const priceFeedId: { [key in typeof validChainIds[number]]: string } = {
  11155111: '0xff61491a931112ddf1bd8147cd1b641375f79f5825126d665480874634fd0ace',   // Ethereum Sepolia
  11155420: '0xff61491a931112ddf1bd8147cd1b641375f79f5825126d665480874634fd0ace',   // Optimism Sepolia
  84532: '0xff61491a931112ddf1bd8147cd1b641375f79f5825126d665480874634fd0ace',      // Base Sepolia
  44787: '0x7d669ddcdd23d9ef1fa9a9cc022ba055ec900e91c4cb960f3c20429d4447a411',      // Celo Alfajores
  8453: '0xff61491a931112ddf1bd8147cd1b641375f79f5825126d665480874634fd0ace',       // Base
  42220: '0x7d669ddcdd23d9ef1fa9a9cc022ba055ec900e91c4cb960f3c20429d4447a411',      // Celo
};

export const easAddress: { [key in typeof validChainIds[number]]: string } = {
  11155111: '0xC2679fBD37d54388Ce493F1DB75320D236e1815e',   // Ethereum Sepolia
  11155420: '0x4200000000000000000000000000000000000021',  // Optimism Sepolia
  84532: '0x4200000000000000000000000000000000000021',      // Base Sepolia
  44787: '0x0',                                             // Celo Alfajores (not available)
  8453: '0x4200000000000000000000000000000000000021',       // Base
  42220: '0x72E1d8ccf5299fb36fEfD8CC4394B8ef7e98Af92',      // Celo
};

export const jarContractAbi = [{"inputs":[{"internalType":"string","name":"_name","type":"string"},{"internalType":"string","name":"_description","type":"string"},{"internalType":"uint256","name":"_withdrawalLimit","type":"uint256"},{"internalType":"uint256","name":"_cooldownPeriod","type":"uint256"},{"internalType":"address","name":"_easAddress","type":"address"},{"internalType":"address","name":"_pythAddress","type":"address"},{"internalType":"bytes32","name":"_priceFeedId","type":"bytes32"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"AccessControlBadConfirmation","type":"error"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"bytes32","name":"neededRole","type":"bytes32"}],"name":"AccessControlUnauthorizedAccount","type":"error"},{"inputs":[],"name":"AccessDenied","type":"error"},{"inputs":[{"internalType":"address","name":"_admin","type":"address"}],"name":"addAdmin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_newMember","type":"address"}],"name":"addDAOMember","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"components":[{"internalType":"bytes32","name":"uid","type":"bytes32"},{"internalType":"bytes32","name":"schema","type":"bytes32"},{"internalType":"uint64","name":"time","type":"uint64"},{"internalType":"uint64","name":"expirationTime","type":"uint64"},{"internalType":"uint64","name":"revocationTime","type":"uint64"},{"internalType":"bytes32","name":"refUID","type":"bytes32"},{"internalType":"address","name":"recipient","type":"address"},{"internalType":"address","name":"attester","type":"address"},{"internalType":"bool","name":"revocable","type":"bool"},{"internalType":"bytes","name":"data","type":"bytes"}],"internalType":"struct Attestation","name":"attestation","type":"tuple"}],"name":"attest","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"},{"internalType":"string","name":"_note","type":"string"},{"internalType":"bytes[]","name":"priceUpdate","type":"bytes[]"}],"name":"deposit","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"grantRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"InsufficientValue","type":"error"},{"inputs":[],"name":"InvalidEAS","type":"error"},{"inputs":[],"name":"InvalidLength","type":"error"},{"inputs":[],"name":"NotPayable","type":"error"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"note","type":"string"},{"indexed":false,"internalType":"uint256","name":"depositId","type":"uint256"},{"indexed":false,"internalType":"bytes32","name":"attestUid","type":"bytes32"}],"name":"DepositMade","type":"event"},{"inputs":[],"name":"emergencyWithdrawNative","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"components":[{"internalType":"bytes32","name":"uid","type":"bytes32"},{"internalType":"bytes32","name":"schema","type":"bytes32"},{"internalType":"uint64","name":"time","type":"uint64"},{"internalType":"uint64","name":"expirationTime","type":"uint64"},{"internalType":"uint64","name":"revocationTime","type":"uint64"},{"internalType":"bytes32","name":"refUID","type":"bytes32"},{"internalType":"address","name":"recipient","type":"address"},{"internalType":"address","name":"attester","type":"address"},{"internalType":"bool","name":"revocable","type":"bool"},{"internalType":"bytes","name":"data","type":"bytes"}],"internalType":"struct Attestation[]","name":"attestations","type":"tuple[]"},{"internalType":"uint256[]","name":"values","type":"uint256[]"}],"name":"multiAttest","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"payable","type":"function"},{"inputs":[{"components":[{"internalType":"bytes32","name":"uid","type":"bytes32"},{"internalType":"bytes32","name":"schema","type":"bytes32"},{"internalType":"uint64","name":"time","type":"uint64"},{"internalType":"uint64","name":"expirationTime","type":"uint64"},{"internalType":"uint64","name":"revocationTime","type":"uint64"},{"internalType":"bytes32","name":"refUID","type":"bytes32"},{"internalType":"address","name":"recipient","type":"address"},{"internalType":"address","name":"attester","type":"address"},{"internalType":"bool","name":"revocable","type":"bool"},{"internalType":"bytes","name":"data","type":"bytes"}],"internalType":"struct Attestation[]","name":"attestations","type":"tuple[]"},{"internalType":"uint256[]","name":"values","type":"uint256[]"}],"name":"multiRevoke","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"_admin","type":"address"}],"name":"removeAdmin","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_member","type":"address"}],"name":"removeDAOMember","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"callerConfirmation","type":"address"}],"name":"renounceRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"components":[{"internalType":"bytes32","name":"uid","type":"bytes32"},{"internalType":"bytes32","name":"schema","type":"bytes32"},{"internalType":"uint64","name":"time","type":"uint64"},{"internalType":"uint64","name":"expirationTime","type":"uint64"},{"internalType":"uint64","name":"revocationTime","type":"uint64"},{"internalType":"bytes32","name":"refUID","type":"bytes32"},{"internalType":"address","name":"recipient","type":"address"},{"internalType":"address","name":"attester","type":"address"},{"internalType":"bool","name":"revocable","type":"bool"},{"internalType":"bytes","name":"data","type":"bytes"}],"internalType":"struct Attestation","name":"attestation","type":"tuple"}],"name":"revoke","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"revokeRole","outputs":[],"stateMutability":"nonpayable","type":"function"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"previousAdminRole","type":"bytes32"},{"indexed":true,"internalType":"bytes32","name":"newAdminRole","type":"bytes32"}],"name":"RoleAdminChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleGranted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"bytes32","name":"role","type":"bytes32"},{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"sender","type":"address"}],"name":"RoleRevoked","type":"event"},{"inputs":[{"internalType":"uint256","name":"_newPeriod","type":"uint256"}],"name":"setCooldownPeriod","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newLimit","type":"uint256"}],"name":"setWithdrawalLimit","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_withdrawalId","type":"uint256"},{"internalType":"bool","name":"_isUpvote","type":"bool"}],"name":"voteOnWithdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"voter","type":"address"},{"indexed":false,"internalType":"uint256","name":"withdrawalId","type":"uint256"},{"indexed":false,"internalType":"bytes32","name":"attestUid","type":"bytes32"}],"name":"VoteRemoved","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"voter","type":"address"},{"indexed":false,"internalType":"uint256","name":"withdrawalId","type":"uint256"},{"indexed":false,"internalType":"bool","name":"isUpvote","type":"bool"},{"indexed":false,"internalType":"bytes32","name":"attestUid","type":"bytes32"}],"name":"Voted","type":"event"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"},{"internalType":"string","name":"_note","type":"string"},{"internalType":"bytes[]","name":"priceUpdate","type":"bytes[]"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"string","name":"note","type":"string"},{"indexed":false,"internalType":"uint256","name":"withdrawalId","type":"uint256"},{"indexed":false,"internalType":"bytes32","name":"attestUid","type":"bytes32"}],"name":"WithdrawalMade","type":"event"},{"stateMutability":"payable","type":"receive"},{"inputs":[],"name":"cooldownPeriod","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"DAO_MEMBER_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"DEFAULT_ADMIN_ROLE","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"depositEasSchema","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"deposits","outputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"string","name":"note","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"description","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getDepositsCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"}],"name":"getRoleAdmin","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getWithdrawalsCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"role","type":"bytes32"},{"internalType":"address","name":"account","type":"address"}],"name":"hasRole","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isPayable","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"pure","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"lastVote","outputs":[{"internalType":"bytes32","name":"uid","type":"bytes32"},{"internalType":"bool","name":"isUpvote","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"lastWithdrawalTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"priceFeedId","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"version","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"voteEasSchema","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"withdrawalLimit","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"withdrawals","outputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"string","name":"note","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"int256","name":"votes","type":"int256"},{"internalType":"bytes32","name":"uid","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"withdrawEasSchema","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"}]
export const jarContractBytecode = "0x610100604052348015610010575f80fd5b506040516152ca3803806152ca83398181016040528101906100329190610768565b82600160035f82608081815250508160a081815250508060c081815250505050505f73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16036100b8576040517f83780ffe00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b8073ffffffffffffffffffffffffffffffffffffffff1660e08173ffffffffffffffffffffffffffffffffffffffff1681525050505f60e05173ffffffffffffffffffffffffffffffffffffffff1663f10b5cc86040518163ffffffff1660e01b8152600401602060405180830381865afa158015610139573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061015d9190610878565b90508073ffffffffffffffffffffffffffffffffffffffff166360d7a27860405180608001604052806046815260200161528460469139305f6040518463ffffffff1660e01b81526004016101b49392919061096a565b6020604051808303815f875af11580156101d0573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906101f491906109a6565b6001819055508073ffffffffffffffffffffffffffffffffffffffff166360d7a27860405180608001604052806045815260200161521b60459139305f6040518463ffffffff1660e01b815260040161024f9392919061096a565b6020604051808303815f875af115801561026b573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061028f91906109a6565b6002819055508073ffffffffffffffffffffffffffffffffffffffff166360d7a278604051806060016040528060248152602001615260602491393060016040518463ffffffff1660e01b81526004016102eb9392919061096a565b6020604051808303815f875af1158015610307573d5f803e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061032b91906109a6565b6003819055508260045f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508160098190555087600590816103879190610bc2565b5086600690816103979190610bc2565b5085600781905550846008819055505f3390506103bc5f801b826103fc60201b60201c565b506103ed7ff29a78c020ddf311f61483cfe182d6d833b80b74c6044ef77e24d033c4266a4c826103fc60201b60201c565b50505050505050505050610c91565b5f61040d83836104f160201b60201c565b6104e75760015f808581526020019081526020015f205f015f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f6101000a81548160ff02191690831515021790555061048461055460201b60201c565b73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16847f2f8788117e7eff1d82e926ec794901d17c78024a50270940304540a733656f0d60405160405180910390a4600190506104eb565b5f90505b92915050565b5f805f8481526020019081526020015f205f015f8373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f9054906101000a900460ff16905092915050565b5f33905090565b5f604051905090565b5f80fd5b5f80fd5b5f80fd5b5f80fd5b5f601f19601f8301169050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b6105ba82610574565b810181811067ffffffffffffffff821117156105d9576105d8610584565b5b80604052505050565b5f6105eb61055b565b90506105f782826105b1565b919050565b5f67ffffffffffffffff82111561061657610615610584565b5b61061f82610574565b9050602081019050919050565b8281835e5f83830152505050565b5f61064c610647846105fc565b6105e2565b90508281526020810184848401111561066857610667610570565b5b61067384828561062c565b509392505050565b5f82601f83011261068f5761068e61056c565b5b815161069f84826020860161063a565b91505092915050565b5f819050919050565b6106ba816106a8565b81146106c4575f80fd5b50565b5f815190506106d5816106b1565b92915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f610704826106db565b9050919050565b610714816106fa565b811461071e575f80fd5b50565b5f8151905061072f8161070b565b92915050565b5f819050919050565b61074781610735565b8114610751575f80fd5b50565b5f815190506107628161073e565b92915050565b5f805f805f805f60e0888a03121561078357610782610564565b5b5f88015167ffffffffffffffff8111156107a05761079f610568565b5b6107ac8a828b0161067b565b975050602088015167ffffffffffffffff8111156107cd576107cc610568565b5b6107d98a828b0161067b565b96505060406107ea8a828b016106c7565b95505060606107fb8a828b016106c7565b945050608061080c8a828b01610721565b93505060a061081d8a828b01610721565b92505060c061082e8a828b01610754565b91505092959891949750929550565b5f610847826106fa565b9050919050565b6108578161083d565b8114610861575f80fd5b50565b5f815190506108728161084e565b92915050565b5f6020828403121561088d5761088c610564565b5b5f61089a84828501610864565b91505092915050565b5f81519050919050565b5f82825260208201905092915050565b5f6108c7826108a3565b6108d181856108ad565b93506108e181856020860161062c565b6108ea81610574565b840191505092915050565b5f819050919050565b5f61091861091361090e846106db565b6108f5565b6106db565b9050919050565b5f610929826108fe565b9050919050565b5f61093a8261091f565b9050919050565b61094a81610930565b82525050565b5f8115159050919050565b61096481610950565b82525050565b5f6060820190508181035f83015261098281866108bd565b90506109916020830185610941565b61099e604083018461095b565b949350505050565b5f602082840312156109bb576109ba610564565b5b5f6109c884828501610754565b91505092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f6002820490506001821680610a1557607f821691505b602082108103610a2857610a276109d1565b5b50919050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f60088302610a8a7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82610a4f565b610a948683610a4f565b95508019841693508086168417925050509392505050565b5f610ac6610ac1610abc846106a8565b6108f5565b6106a8565b9050919050565b5f819050919050565b610adf83610aac565b610af3610aeb82610acd565b848454610a5b565b825550505050565b5f90565b610b07610afb565b610b12818484610ad6565b505050565b5b81811015610b3557610b2a5f82610aff565b600181019050610b18565b5050565b601f821115610b7a57610b4b81610a2e565b610b5484610a40565b81016020851015610b63578190505b610b77610b6f85610a40565b830182610b17565b50505b505050565b5f82821c905092915050565b5f610b9a5f1984600802610b7f565b1980831691505092915050565b5f610bb28383610b8b565b9150826002028217905092915050565b610bcb826108a3565b67ffffffffffffffff811115610be457610be3610584565b5b610bee82546109fe565b610bf9828285610b39565b5f60209050601f831160018114610c2a575f8415610c18578287015190505b610c228582610ba7565b865550610c89565b601f198416610c3886610a2e565b5f5b82811015610c5f57848901518255600182019150602085019450602081019050610c3a565b86831015610c7c5784890151610c78601f891682610b8b565b8355505b6001600288020188555050505b505050505050565b60805160a05160c05160e05161453b610ce05f395f8181610ec0015281816113af01528181611538015281816120aa01526129b001525f61187601525f61184d01525f611824015261453b5ff3fe608060405260043610610228575f3560e01c80637284e41611610122578063b02c43d0116100aa578063d6a22d741161006e578063d6a22d7414610838578063dde0195514610862578063e29e98aa1461088a578063e49617e1146108b4578063e60c3505146108e45761026d565b8063b02c43d014610755578063c791058d14610794578063ce46e046146107be578063d547741f146107e8578063d686f459146108105761026d565b806388e5b2d9116100f157806388e5b2d914610667578063901614c11461069757806391d14854146106bf57806391db0b7e146106fb578063a217fddf1461072b5761026d565b80637284e416146105c15780637ddfe78d146105eb57806380ea3de1146106155780638162c0c31461063d5761026d565b806327543a9a116101b05780634de5120e116101745780634de5120e146104ca57806354fd4d50146105065780635a0768ce146105305780635cc070761461055857806370480275146105995761026d565b806327543a9a146103fe5780632e1de285146104285780632f2ff15d1461045057806336568abe146104785780634c5822e4146104a05761026d565b806313253142116101f757806313253142146103175780631785f53c146103335780631999bb9e1461035b5780632361837614610385578063248a9ca3146103c25761026d565b806301ffc9a71461027157806304646a49146102ad57806306fdde03146102d757806307eb2135146103015761026d565b3661026d57610235610914565b61026b576040517f1574f9f300000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b005b5f80fd5b34801561027c575f80fd5b5061029760048036038101906102929190612cdd565b610918565b6040516102a49190612d22565b60405180910390f35b3480156102b8575f80fd5b506102c1610991565b6040516102ce9190612d53565b60405180910390f35b3480156102e2575f80fd5b506102eb610997565b6040516102f89190612ddc565b60405180910390f35b34801561030c575f80fd5b50610315610a23565b005b610331600480360381019061032c9190612faf565b610a7b565b005b34801561033e575f80fd5b5061035960048036038101906103549190613096565b611101565b005b348015610366575f80fd5b5061036f61111d565b60405161037c91906130d9565b60405180910390f35b348015610390575f80fd5b506103ab60048036038101906103a691906130f2565b611123565b6040516103b9929190613130565b60405180910390f35b3480156103cd575f80fd5b506103e860048036038101906103e39190613181565b61115a565b6040516103f591906130d9565b60405180910390f35b348015610409575f80fd5b50610412611176565b60405161041f91906130d9565b60405180910390f35b348015610433575f80fd5b5061044e600480360381019061044991906131d6565b61119a565b005b34801561045b575f80fd5b5061047660048036038101906104719190613214565b61175f565b005b348015610483575f80fd5b5061049e60048036038101906104999190613214565b611781565b005b3480156104ab575f80fd5b506104b46117fc565b6040516104c19190612d53565b60405180910390f35b3480156104d5575f80fd5b506104f060048036038101906104eb9190613096565b611808565b6040516104fd9190612d53565b60405180910390f35b348015610511575f80fd5b5061051a61181d565b6040516105279190612ddc565b60405180910390f35b34801561053b575f80fd5b5061055660048036038101906105519190613252565b6118c0565b005b348015610563575f80fd5b5061057e60048036038101906105799190613252565b6118d7565b604051610590969594939291906132a4565b60405180910390f35b3480156105a4575f80fd5b506105bf60048036038101906105ba9190613096565b6119c3565b005b3480156105cc575f80fd5b506105d56119df565b6040516105e29190612ddc565b60405180910390f35b3480156105f6575f80fd5b506105ff611a6b565b60405161060c9190612d53565b60405180910390f35b348015610620575f80fd5b5061063b60048036038101906106369190613252565b611a71565b005b348015610648575f80fd5b50610651611a88565b60405161065e91906130d9565b60405180910390f35b610681600480360381019061067c91906133b4565b611a8e565b60405161068e9190612d22565b60405180910390f35b3480156106a2575f80fd5b506106bd60048036038101906106b89190612faf565b611ba3565b005b3480156106ca575f80fd5b506106e560048036038101906106e09190613214565b61234e565b6040516106f29190612d22565b60405180910390f35b610715600480360381019061071091906133b4565b6123b1565b6040516107229190612d22565b60405180910390f35b348015610736575f80fd5b5061073f6124c6565b60405161074c91906130d9565b60405180910390f35b348015610760575f80fd5b5061077b60048036038101906107769190613252565b6124cc565b60405161078b9493929190613432565b60405180910390f35b34801561079f575f80fd5b506107a86125ac565b6040516107b591906130d9565b60405180910390f35b3480156107c9575f80fd5b506107d2610914565b6040516107df9190612d22565b60405180910390f35b3480156107f3575f80fd5b5061080e60048036038101906108099190613214565b6125b2565b005b34801561081b575f80fd5b5061083660048036038101906108319190613096565b6125d4565b005b348015610843575f80fd5b5061084c61260e565b60405161085991906130d9565b60405180910390f35b34801561086d575f80fd5b5061088860048036038101906108839190613096565b612614565b005b348015610895575f80fd5b5061089e61264e565b6040516108ab9190612d53565b60405180910390f35b6108ce60048036038101906108c9919061349f565b61265a565b6040516108db9190612d22565b60405180910390f35b6108fe60048036038101906108f9919061349f565b612674565b60405161090b9190612d22565b60405180910390f35b5f90565b5f7f7965db0b000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916148061098a57506109898261268e565b5b9050919050565b60085481565b600580546109a490613513565b80601f01602080910402602001604051908101604052809291908181526020018280546109d090613513565b8015610a1b5780601f106109f257610100808354040283529160200191610a1b565b820191905f5260205f20905b8154815290600101906020018083116109fe57829003601f168201915b505050505081565b5f801b610a2f816126f7565b5f4790503373ffffffffffffffffffffffffffffffffffffffff166108fc8290811502906040515f60405180830381858888f19350505050158015610a76573d5f803e3d5ffd5b505050565b7ff29a78c020ddf311f61483cfe182d6d833b80b74c6044ef77e24d033c4266a4c610aa5816126f7565b5f3411610ae7576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610ade9061358d565b60405180910390fd5b5f60045f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663d47eed4585856040518363ffffffff1660e01b8152600401610b44929190613703565b602060405180830381865afa158015610b5f573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610b839190613739565b90505f60045f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16828686604051602401610bd2929190613703565b6040516020818303038152906040527fef9e5e28000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050604051610c5c91906137a8565b5f6040518083038185875af1925050503d805f8114610c96576040519150601f19603f3d011682016040523d82523d5f602084013e610c9b565b606091505b5050905080610cdf576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610cd690613808565b60405180910390fd5b5f60045f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166331d98b3f6009546040518263ffffffff1660e01b8152600401610d3c91906130d9565b608060405180830381865afa158015610d57573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610d7b9190613948565b90505f815f015160070b13610dc5576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610dbc906139bd565b60405180910390fd5b5f815f015160070b90505f816a52b7d2dcc80cd2e40000008b610de89190613a08565b610df29190613a76565b905080341015610e37576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610e2e90613af0565b60405180910390fd5b80341115610e8f573373ffffffffffffffffffffffffffffffffffffffff166108fc8234610e659190613b0e565b90811502906040515f60405180830381858888f19350505050158015610e8d573d5f803e3d5ffd5b505b5f33600b805490508c8c604051602001610eac9493929190613b41565b60405160208183030381529060405290505f7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1663f17325e7604051806040016040528060025481526020016040518060c001604052803073ffffffffffffffffffffffffffffffffffffffff1681526020015f67ffffffffffffffff1681526020015f151581526020015f801b81526020018781526020015f8152508152506040518263ffffffff1660e01b8152600401610f7d9190613cce565b6020604051808303815f875af1158015610f99573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190610fbd9190613d02565b9050600b60405180608001604052803373ffffffffffffffffffffffffffffffffffffffff1681526020018e81526020018d815260200142815250908060018154018082558091505060019003905f5260205f2090600402015f909190919091505f820151815f015f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506020820151816001015560408201518160020190816110819190613eca565b506060820151816003015550503373ffffffffffffffffffffffffffffffffffffffff167ff2be2941b88b0dbd1e3be13bec271cae09dc38710b82f03408f55b79febbe2758d8d6001600b805490506110da9190613b0e565b856040516110eb9493929190613f99565b60405180910390a2505050505050505050505050565b5f801b61110d816126f7565b6111195f801b836125b2565b5050565b60095481565b600d602052815f5260405f20602052805f5260405f205f9150915050805f015490806001015f9054906101000a900460ff16905082565b5f805f8381526020019081526020015f20600101549050919050565b7ff29a78c020ddf311f61483cfe182d6d833b80b74c6044ef77e24d033c4266a4c81565b7ff29a78c020ddf311f61483cfe182d6d833b80b74c6044ef77e24d033c4266a4c6111c4816126f7565b600a80549050831061120b576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016112029061402d565b60405180910390fd5b5f801b600d5f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8581526020019081526020015f205f0154146114b5575f600d5f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8581526020019081526020015f206040518060400160405290815f8201548152602001600182015f9054906101000a900460ff16151515158152505090508215158160200151151503611329576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161132090614095565b60405180910390fd5b806020015115611372576001600a8581548110611349576113486140b3565b5b905f5260205f2090600602016004015f82825461136691906140e0565b925050819055506113ad565b6001600a8581548110611388576113876140b3565b5b905f5260205f2090600602016004015f8282546113a59190614120565b925050819055505b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff166346926267604051806040016040528060035481526020016040518060400160405280865f015181526020015f8152508152506040518263ffffffff1660e01b815260040161143391906141bb565b5f604051808303815f87803b15801561144a575f80fd5b505af115801561145c573d5f803e3d5ffd5b505050503373ffffffffffffffffffffffffffffffffffffffff167fe2e5ade999c4398ad3a869b0fccb9d2fb965631320edc034c0ae6841efbea0b285835f01516040516114ab9291906141d4565b60405180910390a2505b81156114fa576001600a84815481106114d1576114d06140b3565b5b905f5260205f2090600602016004015f8282546114ee9190614120565b92505081905550611535565b6001600a84815481106115105761150f6140b3565b5b905f5260205f2090600602016004015f82825461152d91906140e0565b925050819055505b5f7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1663f17325e7604051806040016040528060035481526020016040518060c001604052803073ffffffffffffffffffffffffffffffffffffffff1681526020015f67ffffffffffffffff168152602001600115158152602001600a8a815481106115d9576115d86140b3565b5b905f5260205f20906006020160050154815260200133896040516020016116019291906141fb565b60405160208183030381529060405281526020015f8152508152506040518263ffffffff1660e01b81526004016116389190613cce565b6020604051808303815f875af1158015611654573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906116789190613d02565b90506040518060400160405280828152602001841515815250600d5f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f8681526020019081526020015f205f820151815f01556020820151816001015f6101000a81548160ff0219169083151502179055509050503373ffffffffffffffffffffffffffffffffffffffff167fa09eef4b4e423ce84118028f1c90e0dc84ac536273b07c057c76bcb249026dbe85858460405161175193929190614222565b60405180910390a250505050565b6117688261115a565b611771816126f7565b61177b838361270b565b50505050565b6117896127f4565b73ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16146117ed576040517f6697b23200000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b6117f782826127fb565b505050565b5f600a80549050905090565b600c602052805f5260405f205f915090505481565b60606118487f00000000000000000000000000000000000000000000000000000000000000006128e4565b6118717f00000000000000000000000000000000000000000000000000000000000000006128e4565b61189a7f00000000000000000000000000000000000000000000000000000000000000006128e4565b6040516020016118ac939291906142db565b604051602081830303815290604052905090565b5f801b6118cc816126f7565b816007819055505050565b600a81815481106118e6575f80fd5b905f5260205f2090600602015f91509050805f015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff169080600101549080600201805461193090613513565b80601f016020809104026020016040519081016040528092919081815260200182805461195c90613513565b80156119a75780601f1061197e576101008083540402835291602001916119a7565b820191905f5260205f20905b81548152906001019060200180831161198a57829003601f168201915b5050505050908060030154908060040154908060050154905086565b5f801b6119cf816126f7565b6119db5f801b8361175f565b5050565b600680546119ec90613513565b80601f0160208091040260200160405190810160405280929190818152602001828054611a1890613513565b8015611a635780601f10611a3a57610100808354040283529160200191611a63565b820191905f5260205f20905b815481529060010190602001808311611a4657829003601f168201915b505050505081565b60075481565b5f801b611a7d816126f7565b816008819055505050565b60025481565b5f611a976129ae565b5f858590509050838390508114611ada576040517f947d5a8400000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f3490505f5b82811015611b93575f868683818110611afc57611afb6140b3565b5b90506020020135905082811115611b3f576040517f1101129400000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b611b6d898984818110611b5557611b546140b3565b5b9050602002810190611b679190614325565b82612a35565b611b7d575f945050505050611b9b565b808303925050611b8c81612a7f565b9050611ae0565b506001925050505b949350505050565b7ff29a78c020ddf311f61483cfe182d6d833b80b74c6044ef77e24d033c4266a4c611bcd816126f7565b600854600c5f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2054611c18919061434d565b421015611c5a576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611c51906143f0565b60405180910390fd5b600754851115611c9f576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611c9690614458565b60405180910390fd5b5f8511611ce1576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611cd89061358d565b60405180910390fd5b5f60045f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663d47eed4585856040518363ffffffff1660e01b8152600401611d3e929190613703565b602060405180830381865afa158015611d59573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190611d7d9190613739565b90505f60045f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16828686604051602401611dcc929190613703565b6040516020818303038152906040527fef9e5e28000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050604051611e5691906137a8565b5f6040518083038185875af1925050503d805f8114611e90576040519150601f19603f3d011682016040523d82523d5f602084013e611e95565b606091505b5050905080611ed9576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611ed090613808565b60405180910390fd5b5f60045f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166331d98b3f6009546040518263ffffffff1660e01b8152600401611f3691906130d9565b608060405180830381865afa158015611f51573d5f803e3d5ffd5b505050506040513d601f19601f82011682018060405250810190611f759190613948565b90505f815f015160070b13611fbf576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611fb6906139bd565b60405180910390fd5b5f815f015160070b90505f816a52b7d2dcc80cd2e40000008b611fe29190613a08565b611fec9190613a76565b90505f47905081811015612035576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161202c906144c0565b60405180910390fd5b3373ffffffffffffffffffffffffffffffffffffffff166108fc8390811502906040515f60405180830381858888f19350505050158015612078573d5f803e3d5ffd5b505f33600a805490508d8d6040516020016120969493929190613b41565b60405160208183030381529060405290505f7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1663f17325e7604051806040016040528060015481526020016040518060c001604052803073ffffffffffffffffffffffffffffffffffffffff1681526020015f67ffffffffffffffff1681526020015f151581526020015f801b81526020018781526020015f8152508152506040518263ffffffff1660e01b81526004016121679190613cce565b6020604051808303815f875af1158015612183573d5f803e3d5ffd5b505050506040513d601f19601f820116820180604052508101906121a79190613d02565b905042600c5f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2081905550600a6040518060c001604052803373ffffffffffffffffffffffffffffffffffffffff1681526020018f81526020018e81526020014281526020015f815260200183815250908060018154018082558091505060019003905f5260205f2090600602015f909190919091505f820151815f015f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506020820151816001015560408201518160020190816122b99190613eca565b50606082015181600301556080820151816004015560a0820151816005015550503373ffffffffffffffffffffffffffffffffffffffff167fd3211fb1bea3aaaba16656c79d4ee432c22336614ce15be8cf03a3ed310a4eb18e8e6001600a805490506123269190613b0e565b856040516123379493929190613f99565b60405180910390a250505050505050505050505050565b5f805f8481526020019081526020015f205f015f8373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f9054906101000a900460ff16905092915050565b5f6123ba6129ae565b5f8585905090508383905081146123fd576040517f947d5a8400000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f3490505f5b828110156124b6575f86868381811061241f5761241e6140b3565b5b90506020020135905082811115612462576040517f1101129400000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b612490898984818110612478576124776140b3565b5b905060200281019061248a9190614325565b82612a8b565b6124a0575f9450505050506124be565b8083039250506124af81612a7f565b9050612403565b506001925050505b949350505050565b5f801b81565b600b81815481106124db575f80fd5b905f5260205f2090600402015f91509050805f015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff169080600101549080600201805461252590613513565b80601f016020809104026020016040519081016040528092919081815260200182805461255190613513565b801561259c5780601f106125735761010080835404028352916020019161259c565b820191905f5260205f20905b81548152906001019060200180831161257f57829003601f168201915b5050505050908060030154905084565b60035481565b6125bb8261115a565b6125c4816126f7565b6125ce83836127fb565b50505050565b5f801b6125e0816126f7565b61260a7ff29a78c020ddf311f61483cfe182d6d833b80b74c6044ef77e24d033c4266a4c836125b2565b5050565b60015481565b5f801b612620816126f7565b61264a7ff29a78c020ddf311f61483cfe182d6d833b80b74c6044ef77e24d033c4266a4c8361175f565b5050565b5f600a80549050905090565b5f6126636129ae565b61266d8234612a35565b9050919050565b5f61267d6129ae565b6126878234612a8b565b9050919050565b5f7f01ffc9a7000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916149050919050565b612708816127036127f4565b612ad5565b50565b5f612716838361234e565b6127ea5760015f808581526020019081526020015f205f015f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f6101000a81548160ff0219169083151502179055506127876127f4565b73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16847f2f8788117e7eff1d82e926ec794901d17c78024a50270940304540a733656f0d60405160405180910390a4600190506127ee565b5f90505b92915050565b5f33905090565b5f612806838361234e565b156128da575f805f8581526020019081526020015f205f015f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205f6101000a81548160ff0219169083151502179055506128776127f4565b73ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff16847ff6391f5c32d9c69d2a47ea670b442974b53935d1edc7fd64eb21e047a839171b60405160405180910390a4600190506128de565b5f90505b92915050565b60605f60016128f284612b26565b0190505f8167ffffffffffffffff8111156129105761290f612e2e565b5b6040519080825280601f01601f1916602001820160405280156129425781602001600182028036833780820191505090505b5090505f82602001820190505b6001156129a3578080600190039150507f3031323334353637383961626364656600000000000000000000000000000000600a86061a8153600a858161299857612997613a49565b5b0494505f850361294f575b819350505050919050565b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614612a33576040517f4ca8886700000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b565b5f3073ffffffffffffffffffffffffffffffffffffffff168360e0016020810190612a609190613096565b73ffffffffffffffffffffffffffffffffffffffff1614905092915050565b5f600182019050919050565b5f3073ffffffffffffffffffffffffffffffffffffffff168360e0016020810190612ab69190613096565b73ffffffffffffffffffffffffffffffffffffffff1614905092915050565b612adf828261234e565b612b225780826040517fe2517d3f000000000000000000000000000000000000000000000000000000008152600401612b199291906144de565b60405180910390fd5b5050565b5f805f90507a184f03e93ff9f4daa797ed6e38ed64bf6a1f0100000000000000008310612b82577a184f03e93ff9f4daa797ed6e38ed64bf6a1f0100000000000000008381612b7857612b77613a49565b5b0492506040810190505b6d04ee2d6d415b85acef81000000008310612bbf576d04ee2d6d415b85acef81000000008381612bb557612bb4613a49565b5b0492506020810190505b662386f26fc100008310612bee57662386f26fc100008381612be457612be3613a49565b5b0492506010810190505b6305f5e1008310612c17576305f5e1008381612c0d57612c0c613a49565b5b0492506008810190505b6127108310612c3c576127108381612c3257612c31613a49565b5b0492506004810190505b60648310612c5f5760648381612c5557612c54613a49565b5b0492506002810190505b600a8310612c6e576001810190505b80915050919050565b5f604051905090565b5f80fd5b5f80fd5b5f7fffffffff0000000000000000000000000000000000000000000000000000000082169050919050565b612cbc81612c88565b8114612cc6575f80fd5b50565b5f81359050612cd781612cb3565b92915050565b5f60208284031215612cf257612cf1612c80565b5b5f612cff84828501612cc9565b91505092915050565b5f8115159050919050565b612d1c81612d08565b82525050565b5f602082019050612d355f830184612d13565b92915050565b5f819050919050565b612d4d81612d3b565b82525050565b5f602082019050612d665f830184612d44565b92915050565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f601f19601f8301169050919050565b5f612dae82612d6c565b612db88185612d76565b9350612dc8818560208601612d86565b612dd181612d94565b840191505092915050565b5f6020820190508181035f830152612df48184612da4565b905092915050565b612e0581612d3b565b8114612e0f575f80fd5b50565b5f81359050612e2081612dfc565b92915050565b5f80fd5b5f80fd5b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b612e6482612d94565b810181811067ffffffffffffffff82111715612e8357612e82612e2e565b5b80604052505050565b5f612e95612c77565b9050612ea18282612e5b565b919050565b5f67ffffffffffffffff821115612ec057612ebf612e2e565b5b612ec982612d94565b9050602081019050919050565b828183375f83830152505050565b5f612ef6612ef184612ea6565b612e8c565b905082815260208101848484011115612f1257612f11612e2a565b5b612f1d848285612ed6565b509392505050565b5f82601f830112612f3957612f38612e26565b5b8135612f49848260208601612ee4565b91505092915050565b5f80fd5b5f80fd5b5f8083601f840112612f6f57612f6e612e26565b5b8235905067ffffffffffffffff811115612f8c57612f8b612f52565b5b602083019150836020820283011115612fa857612fa7612f56565b5b9250929050565b5f805f8060608587031215612fc757612fc6612c80565b5b5f612fd487828801612e12565b945050602085013567ffffffffffffffff811115612ff557612ff4612c84565b5b61300187828801612f25565b935050604085013567ffffffffffffffff81111561302257613021612c84565b5b61302e87828801612f5a565b925092505092959194509250565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6130658261303c565b9050919050565b6130758161305b565b811461307f575f80fd5b50565b5f813590506130908161306c565b92915050565b5f602082840312156130ab576130aa612c80565b5b5f6130b884828501613082565b91505092915050565b5f819050919050565b6130d3816130c1565b82525050565b5f6020820190506130ec5f8301846130ca565b92915050565b5f806040838503121561310857613107612c80565b5b5f61311585828601613082565b925050602061312685828601612e12565b9150509250929050565b5f6040820190506131435f8301856130ca565b6131506020830184612d13565b9392505050565b613160816130c1565b811461316a575f80fd5b50565b5f8135905061317b81613157565b92915050565b5f6020828403121561319657613195612c80565b5b5f6131a38482850161316d565b91505092915050565b6131b581612d08565b81146131bf575f80fd5b50565b5f813590506131d0816131ac565b92915050565b5f80604083850312156131ec576131eb612c80565b5b5f6131f985828601612e12565b925050602061320a858286016131c2565b9150509250929050565b5f806040838503121561322a57613229612c80565b5b5f6132378582860161316d565b925050602061324885828601613082565b9150509250929050565b5f6020828403121561326757613266612c80565b5b5f61327484828501612e12565b91505092915050565b6132868161305b565b82525050565b5f819050919050565b61329e8161328c565b82525050565b5f60c0820190506132b75f83018961327d565b6132c46020830188612d44565b81810360408301526132d68187612da4565b90506132e56060830186612d44565b6132f26080830185613295565b6132ff60a08301846130ca565b979650505050505050565b5f8083601f84011261331f5761331e612e26565b5b8235905067ffffffffffffffff81111561333c5761333b612f52565b5b60208301915083602082028301111561335857613357612f56565b5b9250929050565b5f8083601f84011261337457613373612e26565b5b8235905067ffffffffffffffff81111561339157613390612f52565b5b6020830191508360208202830111156133ad576133ac612f56565b5b9250929050565b5f805f80604085870312156133cc576133cb612c80565b5b5f85013567ffffffffffffffff8111156133e9576133e8612c84565b5b6133f58782880161330a565b9450945050602085013567ffffffffffffffff81111561341857613417612c84565b5b6134248782880161335f565b925092505092959194509250565b5f6080820190506134455f83018761327d565b6134526020830186612d44565b81810360408301526134648185612da4565b90506134736060830184612d44565b95945050505050565b5f80fd5b5f61014082840312156134965761349561347c565b5b81905092915050565b5f602082840312156134b4576134b3612c80565b5b5f82013567ffffffffffffffff8111156134d1576134d0612c84565b5b6134dd84828501613480565b91505092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f600282049050600182168061352a57607f821691505b60208210810361353d5761353c6134e6565b5b50919050565b7f416d6f756e74206d7573742062652067726561746572207468616e20300000005f82015250565b5f613577601d83612d76565b915061358282613543565b602082019050919050565b5f6020820190508181035f8301526135a48161356b565b9050919050565b5f82825260208201905092915050565b5f819050919050565b5f82825260208201905092915050565b5f6135df83856135c4565b93506135ec838584612ed6565b6135f583612d94565b840190509392505050565b5f61360c8484846135d4565b90509392505050565b5f80fd5b5f80fd5b5f80fd5b5f808335600160200384360303811261363d5761363c61361d565b5b83810192508235915060208301925067ffffffffffffffff82111561366557613664613615565b5b60018202360383131561367b5761367a613619565b5b509250929050565b5f602082019050919050565b5f61369a83856135ab565b9350836020840285016136ac846135bb565b805f5b878110156136f15784840389526136c68284613621565b6136d1868284613600565b95506136dc84613683565b935060208b019a5050506001810190506136af565b50829750879450505050509392505050565b5f6020820190508181035f83015261371c81848661368f565b90509392505050565b5f8151905061373381612dfc565b92915050565b5f6020828403121561374e5761374d612c80565b5b5f61375b84828501613725565b91505092915050565b5f81519050919050565b5f81905092915050565b5f61378282613764565b61378c818561376e565b935061379c818560208601612d86565b80840191505092915050565b5f6137b38284613778565b915081905092915050565b7f5072696365206665656420757064617465206661696c656400000000000000005f82015250565b5f6137f2601883612d76565b91506137fd826137be565b602082019050919050565b5f6020820190508181035f83015261381f816137e6565b9050919050565b5f80fd5b5f8160070b9050919050565b61383f8161382a565b8114613849575f80fd5b50565b5f8151905061385a81613836565b92915050565b5f67ffffffffffffffff82169050919050565b61387c81613860565b8114613886575f80fd5b50565b5f8151905061389781613873565b92915050565b5f8160030b9050919050565b6138b28161389d565b81146138bc575f80fd5b50565b5f815190506138cd816138a9565b92915050565b5f608082840312156138e8576138e7613826565b5b6138f26080612e8c565b90505f6139018482850161384c565b5f83015250602061391484828501613889565b6020830152506040613928848285016138bf565b604083015250606061393c84828501613725565b60608301525092915050565b5f6080828403121561395d5761395c612c80565b5b5f61396a848285016138d3565b91505092915050565b7f496e76616c6964206e617469766520746f6b656e2f55534420707269636500005f82015250565b5f6139a7601e83612d76565b91506139b282613973565b602082019050919050565b5f6020820190508181035f8301526139d48161399b565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f613a1282612d3b565b9150613a1d83612d3b565b9250828202613a2b81612d3b565b91508282048414831517613a4257613a416139db565b5b5092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601260045260245ffd5b5f613a8082612d3b565b9150613a8b83612d3b565b925082613a9b57613a9a613a49565b5b828204905092915050565b7f496e73756666696369656e742066756e647320696e206d73672e76616c7565005f82015250565b5f613ada601f83612d76565b9150613ae582613aa6565b602082019050919050565b5f6020820190508181035f830152613b0781613ace565b9050919050565b5f613b1882612d3b565b9150613b2383612d3b565b9250828203905081811115613b3b57613b3a6139db565b5b92915050565b5f608082019050613b545f83018761327d565b613b616020830186612d44565b613b6e6040830185612d44565b8181036060830152613b808184612da4565b905095945050505050565b613b94816130c1565b82525050565b613ba38161305b565b82525050565b613bb281613860565b82525050565b613bc181612d08565b82525050565b5f613bd182613764565b613bdb81856135c4565b9350613beb818560208601612d86565b613bf481612d94565b840191505092915050565b613c0881612d3b565b82525050565b5f60c083015f830151613c235f860182613b9a565b506020830151613c366020860182613ba9565b506040830151613c496040860182613bb8565b506060830151613c5c6060860182613b8b565b5060808301518482036080860152613c748282613bc7565b91505060a0830151613c8960a0860182613bff565b508091505092915050565b5f604083015f830151613ca95f860182613b8b565b5060208301518482036020860152613cc18282613c0e565b9150508091505092915050565b5f6020820190508181035f830152613ce68184613c94565b905092915050565b5f81519050613cfc81613157565b92915050565b5f60208284031215613d1757613d16612c80565b5b5f613d2484828501613cee565b91505092915050565b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f60088302613d897fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82613d4e565b613d938683613d4e565b95508019841693508086168417925050509392505050565b5f819050919050565b5f613dce613dc9613dc484612d3b565b613dab565b612d3b565b9050919050565b5f819050919050565b613de783613db4565b613dfb613df382613dd5565b848454613d5a565b825550505050565b5f90565b613e0f613e03565b613e1a818484613dde565b505050565b5b81811015613e3d57613e325f82613e07565b600181019050613e20565b5050565b601f821115613e8257613e5381613d2d565b613e5c84613d3f565b81016020851015613e6b578190505b613e7f613e7785613d3f565b830182613e1f565b50505b505050565b5f82821c905092915050565b5f613ea25f1984600802613e87565b1980831691505092915050565b5f613eba8383613e93565b9150826002028217905092915050565b613ed382612d6c565b67ffffffffffffffff811115613eec57613eeb612e2e565b5b613ef68254613513565b613f01828285613e41565b5f60209050601f831160018114613f32575f8415613f20578287015190505b613f2a8582613eaf565b865550613f91565b601f198416613f4086613d2d565b5f5b82811015613f6757848901518255600182019150602085019450602081019050613f42565b86831015613f845784890151613f80601f891682613e93565b8355505b6001600288020188555050505b505050505050565b5f608082019050613fac5f830187612d44565b8181036020830152613fbe8186612da4565b9050613fcd6040830185612d44565b613fda60608301846130ca565b95945050505050565b7f496e76616c6964207769746864726177616c20494400000000000000000000005f82015250565b5f614017601583612d76565b915061402282613fe3565b602082019050919050565b5f6020820190508181035f8301526140448161400b565b9050919050565b7f53616d6520766f746520616761696e00000000000000000000000000000000005f82015250565b5f61407f600f83612d76565b915061408a8261404b565b602082019050919050565b5f6020820190508181035f8301526140ac81614073565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b5f6140ea8261328c565b91506140f58361328c565b925082820390508181125f8412168282135f85121516171561411a576141196139db565b5b92915050565b5f61412a8261328c565b91506141358361328c565b92508282019050828112155f8312168382125f84121516171561415b5761415a6139db565b5b92915050565b604082015f8201516141755f850182613b8b565b5060208201516141886020850182613bff565b50505050565b606082015f8201516141a25f850182613b8b565b5060208201516141b56020850182614161565b50505050565b5f6060820190506141ce5f83018461418e565b92915050565b5f6040820190506141e75f830185612d44565b6141f460208301846130ca565b9392505050565b5f60408201905061420e5f83018561327d565b61421b6020830184612d13565b9392505050565b5f6060820190506142355f830186612d44565b6142426020830185612d13565b61424f60408301846130ca565b949350505050565b5f81905092915050565b5f61426b82612d6c565b6142758185614257565b9350614285818560208601612d86565b80840191505092915050565b7f2e000000000000000000000000000000000000000000000000000000000000005f82015250565b5f6142c5600183614257565b91506142d082614291565b600182019050919050565b5f6142e68286614261565b91506142f1826142b9565b91506142fd8285614261565b9150614308826142b9565b91506143148284614261565b9150819050949350505050565b5f80fd5b5f823560016101400383360303811261434157614340614321565b5b80830191505092915050565b5f61435782612d3b565b915061436283612d3b565b925082820190508082111561437a576143796139db565b5b92915050565b7f436f6f6c646f776e20706572696f64206e6f7420656c61707365642c20706c655f8201527f6173652074727920616761696e206c6174657200000000000000000000000000602082015250565b5f6143da603383612d76565b91506143e582614380565b604082019050919050565b5f6020820190508181035f830152614407816143ce565b9050919050565b7f416d6f756e742065786365656473207769746864726177616c206c696d6974005f82015250565b5f614442601f83612d76565b915061444d8261440e565b602082019050919050565b5f6020820190508181035f83015261446f81614436565b9050919050565b7f496e73756666696369656e742066756e647320696e20746865206a61720000005f82015250565b5f6144aa601d83612d76565b91506144b582614476565b602082019050919050565b5f6020820190508181035f8301526144d78161449e565b9050919050565b5f6040820190506144f15f83018561327d565b6144fe60208301846130ca565b939250505056fea2646970667358221220ac831eca987caf266067fd460b556571064ae810c5f5378cb63cbb7cce65b15364736f6c634300081a003328616464726573732064616f5f6d656d6265722c2075696e74323536206465706f7369745f69642c2075696e7432353620616d6f756e742c20737472696e67206e6f74652928616464726573732064616f5f6d656d6265722c20626f6f6c2069735f7570766f74652928616464726573732064616f5f6d656d6265722c2075696e743235362077697468647261775f69642c2075696e7432353620616d6f756e742c20737472696e67206e6f746529";
const Home: NextPage = () => {
  const { address } = useAccount();
  const chainId = useChainId() as typeof validChainIds[number];
  const [transactionHash, setTransactionHash] = useState("");
  const receipt = useWaitForTransactionReceipt({
    chainId: chainId,
    hash: transactionHash ? (`${transactionHash}` as `0x${string}`) : undefined,
  });
  const { deployContractAsync } = useDeployContract();
  const [jars, setJars] = useState<Jar[]>([]);
  const [loading, setLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);
  const [modalIsOpen, setModalIsOpen] = useState<boolean>(false);
  const [formSubmitting, setFormSubmitting] = useState<boolean>(false); // New state for form submission
  const [newJar, setNewJar] = useState<{ name: string; description: string, withdrawLimit: number, cooldownPeriod: number, contractAddress: string }>({
    name: 'Jar name',
    description: 'Some description',
    contractAddress: '',
    withdrawLimit: 100,
    cooldownPeriod: 8,
  });

  useEffect(() => {
    // Only fetch jars if address is available
    if (!address) {
      setLoading(true); // Set loading state while waiting for address
      return;
    }

    const fetchJars = async () => {
      try {
        const response = await fetch(`/api/jars?address=${address}&chain=${chainId}`);
        if (!response.ok) {
          throw new Error('Error fetching jars');
        }
        const data: Jar[] = await response.json();
        updateJars(data);
      } catch (err) {
        setError((err as Error).message);
      } finally {
        setLoading(false);
      }
    };

    fetchJars();
  }, [address]);

  const openModal = () => {
    setModalIsOpen(true);
  };

  const closeModal = () => {
    setModalIsOpen(false);
  };

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target;
    setNewJar((prevState) => ({
      ...prevState,
      [name]: value,
    }));
  };

  const updateJars = async (data: Jar[]) => {
    const response = await fetch(`https://hermes.pyth.network/v2/updates/price/latest?ids%5B%5D=${priceFeedId[chainId]}`);
    const res = await response.json();
    const price = BigInt(res.parsed[0].price.price);
    
    const jarsWithBalance = await Promise.all(
      data.map(async (jar) => {
        return {
          ...jar,
          balance: Math.ceil(Number((await getBalance(config, {chainId: chainId, address: jar.contractAddress as `0x${string}`})).value * price / BigInt(1e26))),
        }
      })
    );
    setJars(jarsWithBalance);
  }

  useEffect(() => {
    if (receipt.status === 'success') {
      const createJar = async () => {
        try {
          const response = await fetch(`/api/jars?address=${address}&chain=${chainId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({...newJar, contractAddress: receipt.data?.contractAddress}),
          });

          if (!response.ok) {
            throw new Error('Error creating jar');
          }

          const jar: Jar = await response.json();
          console.log('got jar:', jar);
          const data: Jar[] = [jar, ...jars];
          updateJars(data);

          closeModal();
        } catch (err) {
          setError((err as Error).message);
        } finally {
          setFormSubmitting(false); // Reset form submission state
        }
      };

      createJar();
    }
  }, [receipt.status]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setFormSubmitting(true); // Reset form submission state
    try {
      console.log('posting jar', JSON.stringify(newJar));
      try {
        console.log(chainId, easAddress[chainId], ["cookie", "test", 100, 28800, easAddress[chainId], pythAddress[chainId], priceFeedId[chainId]]);
        const hash = await deployContractAsync({
          abi: jarContractAbi,
          args: ["cookie", "test", 100, 28800, easAddress[chainId], pythAddress[chainId], priceFeedId[chainId]],
          bytecode: jarContractBytecode,
        });
        console.log('hash:', hash);
        setTransactionHash(hash);
      } catch (err) {
        console.log(err);
        setTransactionHash("");
      }
    } catch (err) {
      setError((err as Error).message);
    } finally {
      setFormSubmitting(false); // Reset form submission state
    }
  };


  return (
    <div className={styles.container}>
      <Head>
        <title>Cookie Jar</title>
        <meta
          content="Cookie Jar"
          name="description"
        />
        <link href="/favicon.png" rel="icon" />
      </Head>

      <main className={styles.main}>
        <ConnectButton />
        <button onClick={openModal} className={styles.modalButton}>
          Create New Jar
        </button>

        <Modal 
          isOpen={modalIsOpen} 
          onRequestClose={closeModal} 
          ariaHideApp={false} 
          contentLabel="Create New Jar"
          className={styles.modalContent}
        >
          <h2>Create a New Jar</h2>
          <form onSubmit={handleSubmit} className={styles.modalContent}>
            <label className={styles.modalLabel}>
              Name:
              <input
                type="text"
                name="name"
                placeholder="Jar name"
                value={newJar.name}
                onChange={handleInputChange}
                required
                className={styles.modalInput}
              />
            </label>
            <label className={styles.modalLabel}>
              Description:
              <input
                type="text"
                name="description"
                placeholder="Some description"
                value={newJar.description}
                onChange={handleInputChange}
                required
                className={styles.modalInput}
              />
            </label>
            <label className={styles.modalLabel}>
              Withdrawal limit (in USD):
              <input
                type="number"
                name="withdraw-limit"
                value={newJar.withdrawLimit}
                onChange={handleInputChange}
                required
                className={styles.modalInput}
              />
            </label>
            <label className={styles.modalLabel}>
              Cooldown period (in hours):
              <input
                type="number"
                name="cooldown-period"
                value={newJar.cooldownPeriod}
                onChange={handleInputChange}
                step="1"
                required
                className={styles.modalInput}
              />
            </label>
            <div>
              <button type="submit" className={styles.modalButton}>Create</button>
              <button type="button" onClick={closeModal} className={styles.modalButton + ' ' + styles.modalButtonCancel}>
                Cancel
              </button>
              {formSubmitting && <p>Submitting...</p>}
            </div>
          </form>
        </Modal>

        <div>
          <label>Transaction Receipt</label>
          <pre>
            <code>
              {receipt.status === "pending"
                ? `Status: ${receipt.status}\n\nWaiting...`
                : ""}
              {receipt.status === "error"
                ? `Status: ${receipt.status}\n\n${receipt?.failureReason?.message}`
                : ""}
              {receipt.status === "success"
                ? `Status: ${receipt.status}\n\n${receipt?.data?.contractAddress}`
                : ""}
            </code>
          </pre>

          {receipt?.data?.contractAddress ? (
            <p>
              <a
                className="button"
                href={`${receipt?.data?.contractAddress}`}
                target="_blank"
              >
                Beratrail Contract Address Link
              </a>
            </p>
          ) : null}
        </div>

        {loading ? (
          <p>Loading...</p>
        ) : error ? (
          <p>Error: {error}</p>
        ) : (
          <div className={styles.grid}>
            {jars.map((jar) => {
              const href = `/jar?jarAddress=${jar.contractAddress}&chain=${chainId}`;
              return (
                <a key={jar.contractAddress} className={styles.card} href={href}>
                  <h2>{jar.name} &rarr;</h2>
                  <p>{jar.description}</p>
                  <p>{jar.contractAddress}, balance: {jar.balance.toString()}</p>
                </a>
              )
            })}
          </div>
        )}
      </main>
    </div>
  );
};

export default Home;
